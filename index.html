<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Calculadora ARICAS - Multi Bombeiro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="min-h-screen flex flex-col items-center pb-10 bg-gray-900 text-white">

<header class="w-full bg-red-700 p-4 shadow-lg flex items-center justify-center gap-3">
    <i data-lucide="flame" class="text-yellow-400 w-8 h-8"></i>
    <h1 class="text-2xl font-bold tracking-wider text-white">ARICAS CBSLeiria</h1>
</header>

<!-- TABS DOS 6 BOMBEIROS + RESUMO -->
<div class="w-full max-w-md mt-4 px-4 flex justify-between gap-1" id="tabs-container">
    <button id="tab-1" onclick="selectFF(1)" class="flex-1 py-2 rounded bg-red-600 border-2 border-white text-white text-sm font-bold">
        1
    </button>
    <button id="tab-2" onclick="selectFF(2)" class="flex-1 py-2 rounded bg-gray-700 text-white text-sm font-bold">2</button>
    <button id="tab-3" onclick="selectFF(3)" class="flex-1 py-2 rounded bg-gray-700 text-white text-sm font-bold">3</button>
    <button id="tab-4" onclick="selectFF(4)" class="flex-1 py-2 rounded bg-gray-700 text-white text-sm font-bold">4</button>
    <button id="tab-5" onclick="selectFF(5)" class="flex-1 py-2 rounded bg-gray-700 text-white text-sm font-bold">5</button>
    <button id="tab-6" onclick="selectFF(6)" class="flex-1 py-2 rounded bg-gray-700 text-white text-sm font-bold">6</button>
    <!-- Tab de RESUMO com √≠cone -->
    <button id="tab-summary" onclick="selectSummaryTab()" class="flex-1 py-2 rounded bg-gray-800 text-gray-200 text-xs font-bold flex items-center justify-center gap-1">
        <i data-lucide="list" class="w-4 h-4"></i>
    </button>
</div>

<!-- VISTA PRINCIPAL (BOMBEIROS) -->
<main id="ff-view" class="w-full max-w-md px-4 mt-6 space-y-6">

    <!-- Nome do Bombeiro -->
    <section class="bg-gray-800 p-4 rounded-xl border border-gray-700">
        <label class="block text-gray-400 text-sm mb-1">Nome do Bombeiro</label>
        <input id="ff-name" type="text"
               class="w-full bg-gray-900 p-2 rounded border border-gray-700"
               placeholder="Ex: Bombeiro Silva"
               oninput="updateName(this.value)">
    </section>

    <!-- 1. Volume da Garrafa -->
    <section class="bg-gray-800 rounded-xl p-5 border border-gray-700">
        <label class="block text-gray-400 text-sm font-bold mb-3 uppercase tracking-wide">
            1. Volume da Garrafa
        </label>
        <div class="grid grid-cols-3 gap-2">
            <button onclick="setVolume(6)" id="vol-6"
                    class="vol-btn bg-gray-700 py-3 rounded-lg font-bold">
                6 L
            </button>
            <button onclick="setVolume(6.8)" id="vol-6.8"
                    class="vol-btn bg-gray-700 py-3 rounded-lg font-bold">
                6.8 L
            </button>
            <button onclick="setVolume(9)" id="vol-9"
                    class="vol-btn bg-gray-700 py-3 rounded-lg font-bold">
                9 L
            </button>
        </div>
    </section>

    <!-- 2. Consumo de Ar (Esfor√ßo) -->
    <section class="bg-gray-800 rounded-xl p-5 border border-gray-700">
        <label class="block text-gray-400 text-sm font-bold mb-3 uppercase tracking-wide flex justify-between">
            <span>2. Ritmo de Trabalho</span>
            <span id="consumption-display" class="text-red-400 text-xs">Intenso (45 L/min)</span>
        </label>
        <div class="grid grid-cols-2 gap-2">
            <button onclick="setConsumption(40)" id="cons-40"
                    class="cons-btn bg-gray-700 py-3 rounded-lg font-bold text-sm">
                Moderado<br><span class="text-xs opacity-70 font-normal">40 L/min</span>
            </button>
            <button onclick="setConsumption(45)" id="cons-45"
                    class="cons-btn bg-gray-700 py-3 rounded-lg font-bold text-sm">
                Intenso<br><span class="text-xs opacity-70 font-normal">45 L/min</span>
            </button>
        </div>
    </section>

    <!-- 3. Press√£o Atual -->
    <section class="bg-gray-800 rounded-xl p-5 border border-gray-700">
        <label class="block text-gray-400 text-sm font-bold mb-3 uppercase tracking-wide">
            3. Press√£o Atual (Bar)
        </label>

        <div class="flex items-center gap-4">
            <button onclick="adjustPressure(-10)"
                    class="bg-gray-600 w-12 h-12 rounded-full flex items-center justify-center text-xl font-bold shadow-lg">
                -
            </button>

            <div class="relative flex-1">
                <input type="number" id="pressure" value="300"
                       class="w-full bg-gray-900 text-center text-4xl font-bold text-white border-2 border-gray-600 rounded-lg py-2 focus:outline-none focus:border-red-500 transition-colors"
                       oninput="updatePressureInput()">
                <span class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 text-sm">BAR</span>
            </div>

            <button onclick="adjustPressure(10)"
                    class="bg-gray-600 w-12 h-12 rounded-full flex items-center justify-center text-xl font-bold shadow-lg">
                +
            </button>
        </div>

        <!-- Quick Presets -->
        <div class="flex justify-center gap-2 mt-4">
            <button onclick="setPressure(300)" class="bg-gray-700 px-3 py-1 rounded text-sm text-gray-300">300</button>
            <button onclick="setPressure(280)" class="bg-gray-700 px-3 py-1 rounded text-sm text-gray-300">280</button>
            <button onclick="setPressure(200)" class="bg-gray-700 px-3 py-1 rounded text-sm text-gray-300">200</button>
            <button onclick="setPressure(150)" class="bg-gray-700 px-3 py-1 rounded text-sm text-gray-300">150</button>
        </div>
    </section>

    <!-- RESULTADOS + BARRA DE PROGRESSO -->
    <section class="bg-gray-900 rounded-xl p-6 border border-gray-700 text-center">
        <p class="text-gray-400 text-sm uppercase tracking-widest mb-1">Tempo Dispon√≠vel</p>
        <div class="flex items-baseline justify-center gap-1">
            <span id="result-minutes" class="text-7xl font-bold text-white tabular-nums tracking-tighter">00</span>
            <span class="text-xl text-gray-400">min</span>
        </div>

        <div class="w-full bg-gray-700 rounded-full h-4 mt-4 overflow-hidden">
            <div id="progress-bar"
                 class="h-4 rounded-full transition-all duration-500"
                 style="width: 100%; background:#22c55e;"></div>
        </div>
    </section>

    <!-- Controlo de Entrada -->
    <section class="bg-blue-900/20 border border-blue-800/50 rounded-xl p-5">
        <div class="flex items-center justify-between mb-2">
            <h3 class="text-blue-200 font-bold flex items-center gap-2">
                <i data-lucide="clock" class="w-4 h-4"></i> Controlo de Entrada
            </h3>
            <button onclick="enterNow()"
                    class="bg-blue-600 hover:bg-blue-500 text-white text-xs px-3 py-1 rounded uppercase font-bold tracking-wide">
                Entrar Agora
            </button>
        </div>
        <div class="flex justify-between items-end">
            <div>
                <p class="text-xs text-gray-400">Se entrou √†s:</p>
                <p id="entry-time" class="text-xl font-mono text-white">--:--</p>
            </div>
            <div class="text-right">
                <p class="text-xs text-gray-400">Deve sair √†s:</p>
                <p id="exit-time" class="text-3xl font-mono font-bold text-red-400">--:--</p>
            </div>
        </div>
    </section>
</main>

<!-- VISTA RESUMO (TAB R) -->
<section id="summary-view" class="w-full max-w-md px-4 mt-6 hidden">
    <h2 class="text-sm font-bold text-gray-300 uppercase tracking-wide mb-2 flex items-center gap-2">
        <i data-lucide="list" class="w-4 h-4"></i>
        Resumo dos Bombeiros em Trabalho
    </h2>

    <div id="summary-list" class="bg-gray-800 border border-gray-700 rounded-xl p-3 text-sm text-gray-200 mb-4">
        <p class="text-gray-500 text-xs">Nenhum em trabalho.</p>
    </div>

    <!-- Observa√ß√µes -->
    <section class="bg-gray-800 border border-gray-700 rounded-xl p-3 mb-3">
        <label class="block text-xs font-bold text-gray-300 mb-1">Observa√ß√µes para o relat√≥rio</label>
        <textarea id="obs-text"
                  class="w-full bg-gray-900 border border-gray-600 rounded p-2 text-xs resize-y min-h-[60px]"
                  placeholder="Ex: Equipa 1 em cave, condi√ß√µes dif√≠ceis..."
                  oninput="updateObservations(this.value)"></textarea>
    </section>

    <!-- Bot√µes no Resumo -->
    <div class="flex justify-between mt-1 gap-2">
        <button onclick="exportPDF()"
                class="flex-1 bg-gray-700 hover:bg-gray-600 text-xs px-3 py-1 rounded font-bold flex items-center justify-center gap-1">
            <i data-lucide="download" class="w-3 h-3"></i> Exportar PDF
        </button>
        <button onclick="resetAll()"
                class="flex-1 bg-red-700 hover:bg-red-600 text-xs px-3 py-1 rounded font-bold">
            Reset Geral
        </button>
    </div>
</section>

<!-- Popup Customizado -->
<div id="critical-popup" class="fixed inset-0 bg-black/70 flex items-center justify-center hidden">
  <div class="bg-red-700 p-6 rounded-xl shadow-xl text-center max-w-xs border-2 border-white">
    <h2 class="text-2xl font-bold mb-3">‚ö†Ô∏è ALERTA CR√çTICO ‚ö†Ô∏è</h2>
    <p id="popup-text" class="text-lg mb-4">Em perigo</p>
    <button onclick="closePopup()" class="bg-white text-red-700 font-bold px-4 py-2 rounded">OK</button>
  </div>
</div>

<!-- RODAP√â -->
<footer class="w-full mt-8 px-4 text-center text-xs text-gray-500 leading-relaxed">
    SCh2¬™ Jo√£o Paulo Pereira<br>
    Companhia Bombeiros Sapadores Leiria
</footer>

<script>
lucide.createIcons();

const reservePressure = 50;
const NUM_FF = 6;
const STORAGE_KEY = "aricas_state_v1";

// Estado dos bombeiros
const firefighters = [];
for (let i = 0; i < NUM_FF; i++) {
    firefighters.push({
        name: "",
        volume: 6.8,
        consumption: 45,
        pressure: 300,
        entryTimeStr: "--:--",
        exitTimeStr: "--:--",
        entryTimestamp: null,
        initialMinutes: null,
        remainingMinutes: null,
        alertShown: false,
        inWork: false
    });
}

// Hist√≥rico de entradas/sa√≠das
const logs = [];

// Observa√ß√µes
let observations = "";

// Estado da UI
let activeIndex = 0; // 0..5
let activeView  = "ff"; // "ff" ou "summary"
let notificationsEnabled = false;

// DOM refs
const nameInput       = document.getElementById("ff-name");
const pressureInput   = document.getElementById("pressure");
const resultMinutesEl = document.getElementById("result-minutes");
const progressBarEl   = document.getElementById("progress-bar");
const entryTimeEl     = document.getElementById("entry-time");
const exitTimeEl      = document.getElementById("exit-time");
const consumptionDisplay = document.getElementById("consumption-display");
const summaryListEl   = document.getElementById("summary-list");
const ffViewEl        = document.getElementById("ff-view");
const summaryViewEl   = document.getElementById("summary-view");
const obsTextEl       = document.getElementById("obs-text");

// ---------- LOCALSTORAGE ----------
function saveState() {
    try {
        const data = {
            firefighters: firefighters,
            logs: logs,
            activeIndex: activeIndex,
            activeView: activeView,
            observations: observations
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    } catch (e) {
        console.warn("N√£o foi poss√≠vel guardar o estado:", e);
    }
}

function loadState() {
    try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return;
        const data = JSON.parse(raw);

        if (data.firefighters && Array.isArray(data.firefighters)) {
            data.firefighters.forEach(function(fd, i) {
                if (i < NUM_FF && fd) {
                    Object.assign(firefighters[i], fd);
                }
            });
        }

        if (data.logs && Array.isArray(data.logs)) {
            logs.length = 0;
            data.logs.forEach(function(l) { logs.push(l); });
        }

        if (typeof data.activeIndex === "number") {
            activeIndex = Math.min(NUM_FF - 1, Math.max(0, data.activeIndex));
        }
        if (data.activeView === "ff" || data.activeView === "summary") {
            activeView = data.activeView;
        }

        if (typeof data.observations === "string") {
            observations = data.observations;
            obsTextEl.value = observations;
        }
    } catch (e) {
        console.warn("N√£o foi poss√≠vel carregar o estado:", e);
    }
}

// Pedir permiss√£o para notifica√ß√µes
function askNotificationPermission() {
    if (!("Notification" in window)) return;
    Notification.requestPermission().then(function(perm) {
        if (perm === "granted") notificationsEnabled = true;
    }).catch(function() {
        notificationsEnabled = false;
    });
}
askNotificationPermission();

// Vibra√ß√£o (smartphones)
function vibrate(ms) {
    if (ms === undefined) ms = 400;
    if (navigator.vibrate) {
        navigator.vibrate(ms);
    }
}

// Aviso sonoro (beep simples)
function playBeep() {
    try {
        var AudioCtx = window.AudioContext || window.webkitAudioContext;
        var ctx = new AudioCtx();
        var osc = ctx.createOscillator();
        var gain = ctx.createGain();

        osc.type = "sine";
        osc.frequency.value = 1000;

        osc.connect(gain);
        gain.connect(ctx.destination);

        var now = ctx.currentTime;
        gain.gain.setValueAtTime(0.0001, now);
        gain.gain.exponentialRampToValueAtTime(0.8, now + 0.01);
        gain.gain.exponentialRampToValueAtTime(0.0001, now + 0.7);

        osc.start(now);
        osc.stop(now + 0.7);
    } catch (e) {
        console.warn("AudioContext n√£o suportado ou bloqueado pelo browser.", e);
    }
}

// Observa√ß√µes
function updateObservations(val) {
    observations = val;
    saveState();
}

// Atualizar visibilidade das vistas
function updateViewVisibility() {
    if (activeView === "ff") {
        ffViewEl.classList.remove("hidden");
        summaryViewEl.classList.add("hidden");
    } else {
        ffViewEl.classList.add("hidden");
        summaryViewEl.classList.remove("hidden");
    }
}

// Atualizar nome
function updateName(val) {
    firefighters[activeIndex].name = val;
    renderSummary();
    saveState();
}

// Selecionar bombeiro
function selectFF(n) {
    activeView  = "ff";
    activeIndex = n - 1;
    renderUI();
    updateViewVisibility();
    saveState();
}

// Selecionar tab de resumo
function selectSummaryTab() {
    activeView = "summary";
    highlightTabs();
    updateViewVisibility();
    renderSummary();
    saveState();
}

// Ir para bombeiro ao clicar no resumo
function goToFirefighter(index) {
    activeIndex = index;
    activeView = "ff";
    renderUI();
    updateViewVisibility();
    saveState();
}

// Destacar tabs
function highlightTabs() {
    for (var i = 0; i < NUM_FF; i++) {
        var tab = document.getElementById("tab-" + (i + 1));
        if (!tab) continue;

        tab.className = "flex-1 py-2 rounded bg-gray-700 text-white text-sm font-bold";

        var f = firefighters[i];
        if (activeView === "ff" && i === activeIndex) {
            tab.classList.add("bg-red-600", "border-2", "border-white");
        }

        if (f.entryTimestamp && f.initialMinutes != null && f.inWork) {
            var elapsed   = (Date.now() - f.entryTimestamp) / 60000;
            var remaining = Math.max(0, Math.floor(f.initialMinutes - elapsed));

            if (remaining <= 5) {
                tab.classList.add("ring-2", "ring-red-500", "animate-pulse");
            } else if (remaining <= 10) {
                tab.classList.add("ring-2", "ring-orange-400");
            }
        }
    }

    var sTab = document.getElementById("tab-summary");
    if (sTab) {
        sTab.className = "flex-1 py-2 rounded bg-gray-800 text-gray-200 text-xs font-bold flex items-center justify-center gap-1";
        if (activeView === "summary") {
            sTab.classList.add("border-2", "border-white", "bg-blue-700", "text-white");
        }
    }
}

// Destacar volume
function highlightVolumeButtons() {
    var volBtns = document.querySelectorAll(".vol-btn");
    volBtns.forEach(function(btn) {
        btn.classList.remove("bg-red-600","border-white","text-white","shadow-lg","shadow-red-900/50");
        btn.classList.add("bg-gray-700");
    });
    var vol = firefighters[activeIndex].volume;
    var btn = document.getElementById("vol-" + vol);
    if (btn) {
        btn.classList.remove("bg-gray-700");
        btn.classList.add("bg-red-600","border-white","text-white","shadow-lg","shadow-red-900/50");
    }
}

// Destacar consumo
function highlightConsumptionButtons() {
    var consBtns = document.querySelectorAll(".cons-btn");
    consBtns.forEach(function(btn) {
        btn.classList.remove("bg-red-600","border-white","text-white");
        btn.classList.add("bg-gray-700");
    });
    var cons = firefighters[activeIndex].consumption;
    var btn = document.getElementById("cons-" + cons);
    if (btn) {
        btn.classList.remove("bg-gray-700");
        btn.classList.add("bg-red-600","border-white","text-white");
    }
    var label = cons === 45 ? "Intenso (45 L/min)" : "Moderado (40 L/min)";
    consumptionDisplay.textContent = label;
}

// Set volume
function setVolume(v) {
    firefighters[activeIndex].volume = v;
    highlightVolumeButtons();
    updateTimeAndBar();
    renderSummary();
    saveState();
}

// Set consumo
function setConsumption(c) {
    firefighters[activeIndex].consumption = c;
    highlightConsumptionButtons();
    updateTimeAndBar();
    renderSummary();
    saveState();
}

// Ajustar press√£o
function adjustPressure(delta) {
    var f = firefighters[activeIndex];
    var val = parseInt(pressureInput.value, 10) || 0;
    val += delta;
    if (val < 0) val = 0;
    if (val > 400) val = 400;
    f.pressure = val;
    pressureInput.value = val;
    updateTimeAndBar();
    renderSummary();
    saveState();
}

// Definir press√£o direta
function setPressure(val) {
    var f = firefighters[activeIndex];
    f.pressure = val;
    pressureInput.value = val;
    updateTimeAndBar();
    renderSummary();
    saveState();
}

// Atualizar press√£o a partir do input
function updatePressureInput() {
    var f = firefighters[activeIndex];
    f.pressure = parseInt(pressureInput.value, 10) || 0;
    updateTimeAndBar();
    renderSummary();
    saveState();
}

// Calcula minutos te√≥ricos
function computePhysicalMinutes(f) {
    var usefulPressure = Math.max(0, f.pressure - reservePressure);
    var usefulLiters   = usefulPressure * f.volume;
    var minutes        = usefulLiters / f.consumption;
    return Math.floor(minutes);
}

// Atualiza tempo e barra
function updateTimeAndBar() {
    var f = firefighters[activeIndex];

    var minutes;
    if (f.entryTimestamp && f.initialMinutes != null && f.inWork) {
        var elapsed = (Date.now() - f.entryTimestamp) / 60000;
        minutes = Math.max(0, Math.floor(f.initialMinutes - elapsed));
        f.remainingMinutes = minutes;
    } else {
        minutes = computePhysicalMinutes(f);
        f.remainingMinutes = minutes;
        f.initialMinutes   = minutes;
    }

    if (isNaN(minutes)) {
        resultMinutesEl.textContent = "00";
    } else {
        resultMinutesEl.textContent = String(minutes).padStart(2, "0");
    }

    var pct = 100;
    if (f.initialMinutes && f.initialMinutes > 0) {
        pct = Math.max(0, Math.min(100, (minutes / f.initialMinutes) * 100));
    }
    progressBarEl.style.width = pct + "%";

    if (minutes <= 5) {
        progressBarEl.style.background = "#dc2626";
    } else if (minutes <= 10) {
        progressBarEl.style.background = "#f97316";
    } else {
        progressBarEl.style.background = "#22c55e";
    }
}

// Carregar estado do bombeiro ativo
function renderUI() {
    highlightTabs();

    var f = firefighters[activeIndex];

    nameInput.value = f.name || "";
    pressureInput.value = f.pressure;
    entryTimeEl.textContent = f.entryTimeStr;
    exitTimeEl.textContent  = f.exitTimeStr;

    highlightVolumeButtons();
    highlightConsumptionButtons();

    updateTimeAndBar();
    renderSummary();
}

// Entrar Agora
function enterNow() {
    var f = firefighters[activeIndex];
    var now = new Date();

    var minutes = computePhysicalMinutes(f);
    if (minutes <= 0) return;

    var entryTimestamp = Date.now();
    f.entryTimestamp = entryTimestamp;
    f.initialMinutes = minutes;
    f.remainingMinutes = minutes;
    f.inWork = true;

    f.entryTimeStr = now.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
    var exitTime = new Date(now.getTime() + minutes * 60000);
    f.exitTimeStr  = exitTime.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
    f.alertShown = false;

    // Registo no hist√≥rico (n√£o √© apagado)
    logs.push({
        ffIndex: activeIndex,
        name: f.name || ("Bombeiro " + (activeIndex + 1)),
        volume: f.volume,
        consumption: f.consumption,
        pressure: f.pressure,
        entryTimeStr: f.entryTimeStr,
        exitTimeStr: f.exitTimeStr,
        initialMinutes: minutes,
        entryTimestamp: entryTimestamp
    });

    entryTimeEl.textContent = f.entryTimeStr;
    exitTimeEl.textContent  = f.exitTimeStr;

    updateTimeAndBar();
    highlightTabs();
    renderSummary();
    saveState();
}

// Popup fechar
function closePopup() {
    popupEl.classList.add("hidden");
}

// Limpar bombeiro
function clearFirefighter(index) {
    var f = firefighters[index];
    f.entryTimestamp = null;
    f.initialMinutes = null;
    f.remainingMinutes = null;
    f.entryTimeStr = "--:--";
    f.exitTimeStr = "--:--";
    f.alertShown = false;
    f.inWork = false;

    if (activeIndex === index && activeView === "ff") {
        entryTimeEl.textContent = f.entryTimeStr;
        exitTimeEl.textContent  = f.exitTimeStr;
        updateTimeAndBar();
        highlightTabs();
    }
    renderSummary();
    saveState();
}

// Reset Geral
function resetAll() {
    if (!confirm("Tem a certeza que pretende limpar todos os dados de todos os bombeiros e hist√≥rico?")) return;

    for (var i = 0; i < NUM_FF; i++) {
        var f = firefighters[i];
        f.name = "";
        f.volume = 6.8;
        f.consumption = 45;
        f.pressure = 300;
        f.entryTimeStr = "--:--";
        f.exitTimeStr = "--:--";
        f.entryTimestamp = null;
        f.initialMinutes = null;
        f.remainingMinutes = null;
        f.alertShown = false;
        f.inWork = false;
    }

    logs.length = 0;
    observations = "";
    obsTextEl.value = "";

    activeIndex = 0;
    activeView  = "ff";
    localStorage.removeItem(STORAGE_KEY);

    renderUI();
    updateViewVisibility();
    highlightTabs();
    renderSummary();
}

// Render resumo
function renderSummary() {
    var rows = [];

    for (var i = 0; i < NUM_FF; i++) {
        var f = firefighters[i];
        if (!f.inWork) continue;

        var remaining = f.remainingMinutes;
        var elapsed   = 0;

        if (f.entryTimestamp && f.initialMinutes != null) {
            var diffMin = (Date.now() - f.entryTimestamp) / 60000;
            elapsed = Math.max(0, Math.floor(diffMin));
            remaining = Math.max(0, Math.floor(f.initialMinutes - diffMin));
            f.remainingMinutes = remaining;
        } else {
            remaining = remaining != null ? remaining : computePhysicalMinutes(f);
        }

        rows.push({
            index: i,
            name: f.name || ("Bombeiro " + (i + 1)),
            remaining: remaining,
            elapsed: elapsed,
            exitTime: f.exitTimeStr
        });
    }

    rows.sort(function(a, b) { return a.remaining - b.remaining; });

    if (rows.length === 0) {
        summaryListEl.innerHTML = "<p class='text-gray-500 text-xs'>Nenhum em trabalho.</p>";
        return;
    }

    var html = ""
        + "<div class='grid grid-cols-6 text-[11px] font-bold text-gray-300 border-b border-gray-700 pb-1 mb-2'>"
        + "  <div>#</div>"
        + "  <div>Nome</div>"
        + "  <div>Trabalho</div>"
        + "  <div>Restante</div>"
        + "  <div>Sa√≠da</div>"
        + "  <div></div>"
        + "</div>";

    rows.forEach(function(r) {
        var shownRemaining = Math.max(0, r.remaining);
        var critico = shownRemaining <= 5 && shownRemaining > 0;
        var tempoClass;
        if (critico) {
            tempoClass = "text-red-400 font-bold";
        } else if (shownRemaining <= 10) {
            tempoClass = "text-orange-300";
        } else {
            tempoClass = "text-green-300";
        }

        html += ""
        + "<div class='grid grid-cols-6 text-[11px] items-center py-1 border-b border-gray-800 last:border-b-0 cursor-pointer hover:bg-gray-700/40'"
        + "     onclick='goToFirefighter(" + r.index + ")'>"
        + "  <div class='font-bold text-red-300'>" + (r.index + 1) + "</div>"
        + "  <div class='truncate pr-1'>" + r.name + "</div>"
        + "  <div class='text-gray-200'>" + r.elapsed + " min</div>"
        + "  <div class='" + tempoClass + "'>"
        +       shownRemaining + " min " + (critico ? "üî•" : "")
        + "  </div>"
        + "  <div class='font-mono text-gray-200 text-right'>" + r.exitTime + "</div>"
        + "  <div class='text-right'>"
        + "    <button onclick='event.stopPropagation(); clearFirefighter(" + r.index + ")'"
        + "            class='bg-gray-700 hover:bg-gray-600 text-[10px] px-2 py-1 rounded'>"
        + "      Limpar"
        + "    </button>"
        + "  </div>"
        + "</div>";
    });

    summaryListEl.innerHTML = html;
}

// Exportar PDF (via janela de impress√£o)
function exportPDF() {
    if (logs.length === 0) {
        alert("N√£o existem registos para exportar.");
        return;
    }

    var now = Date.now();
    var nowStr = new Date().toLocaleString("pt-PT");

    var rowsHtml = "";

    logs.forEach(function(log, idx) {
        var ts = log.entryTimestamp || now;
        var d = new Date(ts);
        var dateStr = d.toLocaleDateString("pt-PT");
        var timeStr = log.entryTimeStr || d.toLocaleTimeString("pt-PT", {hour:"2-digit",minute:"2-digit"});

        var diffMin = Math.max(0, Math.floor((now - ts) / 60000));
        var remaining = Math.max(0, Math.floor((log.initialMinutes || 0) - diffMin));

        rowsHtml += ""
        + "<tr>"
        + "  <td>" + (idx + 1) + "</td>"
        + "  <td>" + (log.ffIndex + 1) + "</td>"
        + "  <td>" + (log.name || "") + "</td>"
        + "  <td>" + dateStr + "</td>"
        + "  <td>" + timeStr + "</td>"
        + "  <td>" + (log.exitTimeStr || "") + "</td>"
        + "  <td>" + (log.initialMinutes != null ? log.initialMinutes : "") + "</td>"
        + "  <td>" + diffMin + "</td>"
        + "  <td>" + remaining + "</td>"
        + "  <td>" + log.volume + "</td>"
        + "  <td>" + log.consumption + "</td>"
        + "  <td>" + log.pressure + "</td>"
        + "</tr>";
    });

    var obsHtml = observations
        ? ("<h2>Observa√ß√µes</h2><p>" + observations.replace(/\n/g, "<br>") + "</p>")
        : "<h2>Observa√ß√µes</h2><p>Sem observa√ß√µes.</p>";

    var html = ""
    + "<!DOCTYPE html>"
    + "<html lang='pt-PT'>"
    + "<head>"
    + "<meta charset='utf-8'>"
    + "<title>Relat√≥rio ARICAS</title>"
    + "<style>"
    + "body { font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; font-size: 12px; margin: 20px; color:#111827; }"
    + "h1 { font-size: 20px; margin-bottom: 4px; }"
    + "h2 { font-size: 14px; margin-top: 16px; margin-bottom: 6px; }"
    + "table { width: 100%; border-collapse: collapse; margin-top: 8px; }"
    + "th, td { border: 1px solid #9ca3af; padding: 4px 6px; text-align: left; }"
    + "th { background:#e5e7eb; font-weight: 600; }"
    + ".small { font-size: 10px; color:#6b7280; }"
    + ".header-line { display:flex; justify-content:space-between; align-items:flex-end; margin-bottom:6px; }"
    + "</style>"
    + "</head>"
    + "<body>"
    + "  <div class='header-line'>"
    + "    <div>"
    + "      <h1>Relat√≥rio ARICAS</h1>"
    + "      <div class='small'>Gerado em " + nowStr + "</div>"
    + "      <div class='small'>SCh2¬™ Jo√£o Paulo Pereira - Companhia Bombeiros Sapadores Leiria</div>"
    + "    </div>"
    + "  </div>"

    + "  " + obsHtml

    + "  <h2>Registo de Entradas e Sa√≠das</h2>"
    + "  <table>"
    + "    <thead>"
    + "      <tr>"
    + "        <th># Registo</th>"
    + "        <th>N¬∫</th>"
    + "        <th>Nome</th>"
    + "        <th>Data</th>"
    + "        <th>Hora Entrada</th>"
    + "        <th>Hora Sa√≠da</th>"
    + "        <th>Tempo Previsto (min)</th>"
    + "        <th>Trabalho (min)</th>"
    + "        <th>Restante (min)</th>"
    + "        <th>Volume (L)</th>"
    + "        <th>Consumo (L/min)</th>"
    + "        <th>Press√£o Inicial (bar)</th>"
    + "      </tr>"
    + "    </thead>"
    + "    <tbody>"
    +          rowsHtml
    + "    </tbody>"
    + "  </table>"

    + "  <script>"
    + "    window.onload = function(){ window.print(); };"
    + "  <\/script>"
    + "</body>"
    + "</html>";

    var win = window.open("", "_blank");
    if (!win) {
        alert("O navegador bloqueou a janela de impress√£o. Permita pop-ups para exportar o PDF.");
        return;
    }
    win.document.open();
    win.document.write(html);
    win.document.close();
}

// Verifica√ß√£o peri√≥dica (cada minuto)
setInterval(function() {
    for (var i = 0; i < NUM_FF; i++) {
        var f = firefighters[i];
        if (f.entryTimestamp && f.initialMinutes != null && f.inWork) {
            var elapsed = (Date.now() - f.entryTimestamp) / 60000;
            var remaining = Math.max(0, Math.floor(f.initialMinutes - elapsed));
            f.remainingMinutes = remaining;

            if (remaining <= 5 && !f.alertShown) {
                f.alertShown = true;

                vibrate(500);
                playBeep();

                if (notificationsEnabled && "Notification" in window) {
                    try {
                        new Notification("üö® " + (i + 1), {
                            body: "tem menos de 5 minutos de ar dispon√≠vel!"
                        });
                    } catch(e) {}
                }

                popupTextEl.textContent = (i + 1) + " tem menos de 5 minutos!";
                popupEl.classList.remove("hidden");

                alert((i + 1) + " com autonomia cr√≠tica!");
            }
        }
    }

    updateTimeAndBar();
    highlightTabs();
    renderSummary();
    saveState();
}, 60000);

// Inicializar
loadState();
renderUI();
updateViewVisibility();
</script>

</body>
</html>
