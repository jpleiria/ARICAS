<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Calculadora ARICAS - Multi Bombeiro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="min-h-screen flex flex-col items-center pb-10 bg-gray-900 text-white">

<header class="w-full bg-red-700 p-4 shadow-lg flex items-center justify-center gap-3">
    <i data-lucide="flame" class="text-yellow-400 w-8 h-8"></i>
    <h1 class="text-2xl font-bold tracking-wider text-white">ARICAS CBSLeiria</h1>
</header>

<!-- TABS DOS 6 BOMBEIROS -->
<div class="w-full max-w-md mt-4 px-4 flex justify-between gap-1" id="tabs-container">
    <button id="tab-1" onclick="selectFF(1)" class="flex-1 py-2 rounded bg-red-600 border-2 border-white text-white text-sm font-bold">
        B1
    </button>
    <button id="tab-2" onclick="selectFF(2)" class="flex-1 py-2 rounded bg-gray-700 text-white text-sm font-bold">B2</button>
    <button id="tab-3" onclick="selectFF(3)" class="flex-1 py-2 rounded bg-gray-700 text-white text-sm font-bold">B3</button>
    <button id="tab-4" onclick="selectFF(4)" class="flex-1 py-2 rounded bg-gray-700 text-white text-sm font-bold">B4</button>
    <button id="tab-5" onclick="selectFF(5)" class="flex-1 py-2 rounded bg-gray-700 text-white text-sm font-bold">B5</button>
    <button id="tab-6" onclick="selectFF(6)" class="flex-1 py-2 rounded bg-gray-700 text-white text-sm font-bold">B6</button>
</div>

<!-- √ÅREA DO CONTE√öDO -->
<main class="w-full max-w-md px-4 mt-6 space-y-6">

    <!-- Nome do Bombeiro -->
    <section class="bg-gray-800 p-4 rounded-xl border border-gray-700">
        <label class="block text-gray-400 text-sm mb-1">Nome do Bombeiro</label>
        <input id="ff-name" type="text"
               class="w-full bg-gray-900 p-2 rounded border border-gray-700"
               placeholder="Ex: Bombeiro Silva"
               oninput="updateName(this.value)">
    </section>

    <!-- 1. Volume da Garrafa -->
    <section class="bg-gray-800 rounded-xl p-5 border border-gray-700">
        <label class="block text-gray-400 text-sm font-bold mb-3 uppercase tracking-wide">
            1. Volume da Garrafa
        </label>
        <div class="grid grid-cols-3 gap-2">
            <button onclick="setVolume(6)" id="vol-6"
                    class="vol-btn bg-gray-700 py-3 rounded-lg font-bold">
                6 L
            </button>
            <button onclick="setVolume(6.8)" id="vol-6.8"
                    class="vol-btn bg-gray-700 py-3 rounded-lg font-bold">
                6.8 L
            </button>
            <button onclick="setVolume(9)" id="vol-9"
                    class="vol-btn bg-gray-700 py-3 rounded-lg font-bold">
                9 L
            </button>
        </div>
    </section>

    <!-- 2. Consumo de Ar (Esfor√ßo) -->
    <section class="bg-gray-800 rounded-xl p-5 border border-gray-700">
        <label class="block text-gray-400 text-sm font-bold mb-3 uppercase tracking-wide flex justify-between">
            <span>2. Ritmo de Trabalho</span>
            <span id="consumption-display" class="text-red-400 text-xs">Intenso (45 L/min)</span>
        </label>
        <div class="grid grid-cols-2 gap-2">
            <button onclick="setConsumption(40)" id="cons-40"
                    class="cons-btn bg-gray-700 py-3 rounded-lg font-bold text-sm">
                Moderado<br><span class="text-xs opacity-70 font-normal">40 L/min</span>
            </button>
            <button onclick="setConsumption(45)" id="cons-45"
                    class="cons-btn bg-gray-700 py-3 rounded-lg font-bold text-sm">
                Intenso<br><span class="text-xs opacity-70 font-normal">45 L/min</span>
            </button>
        </div>
    </section>

    <!-- 3. Press√£o Atual -->
    <section class="bg-gray-800 rounded-xl p-5 border border-gray-700">
        <label class="block text-gray-400 text-sm font-bold mb-3 uppercase tracking-wide">
            3. Press√£o Atual (Bar)
        </label>

        <div class="flex items-center gap-4">
            <button onclick="adjustPressure(-10)"
                    class="bg-gray-600 w-12 h-12 rounded-full flex items-center justify-center text-xl font-bold shadow-lg">
                -
            </button>

            <div class="relative flex-1">
                <input type="number" id="pressure" value="300"
                       class="w-full bg-gray-900 text-center text-4xl font-bold text-white border-2 border-gray-600 rounded-lg py-2 focus:outline-none focus:border-red-500 transition-colors"
                       oninput="updatePressureInput()">
                <span class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 text-sm">BAR</span>
            </div>

            <button onclick="adjustPressure(10)"
                    class="bg-gray-600 w-12 h-12 rounded-full flex items-center justify-center text-xl font-bold shadow-lg">
                +
            </button>
        </div>

        <!-- Quick Presets -->
        <div class="flex justify-center gap-2 mt-4">
            <button onclick="setPressure(300)" class="bg-gray-700 px-3 py-1 rounded text-sm text-gray-300">300</button>
            <button onclick="setPressure(280)" class="bg-gray-700 px-3 py-1 rounded text-sm text-gray-300">280</button>
            <button onclick="setPressure(200)" class="bg-gray-700 px-3 py-1 rounded text-sm text-gray-300">200</button>
            <button onclick="setPressure(150)" class="bg-gray-700 px-3 py-1 rounded text-sm text-gray-300">150</button>
        </div>
    </section>

    <!-- RESULTADOS + BARRA DE PROGRESSO -->
    <section class="bg-gray-900 rounded-xl p-6 border border-gray-700 text-center">
        <p class="text-gray-400 text-sm uppercase tracking-widest mb-1">Tempo Dispon√≠vel</p>
        <div class="flex items-baseline justify-center gap-1">
            <span id="result-minutes" class="text-7xl font-bold text-white tabular-nums tracking-tighter">00</span>
            <span class="text-xl text-gray-400">min</span>
        </div>

        <div class="w-full bg-gray-700 rounded-full h-4 mt-4 overflow-hidden">
            <div id="progress-bar"
                 class="h-4 rounded-full transition-all duration-500"
                 style="width: 100%; background:#22c55e;"></div>
        </div>
    </section>

    <!-- Controlo de Entrada -->
    <section class="bg-blue-900/20 border border-blue-800/50 rounded-xl p-5">
        <div class="flex items-center justify-between mb-2">
            <h3 class="text-blue-200 font-bold flex items-center gap-2">
                <i data-lucide="clock" class="w-4 h-4"></i> Controlo de Entrada
            </h3>
            <button onclick="enterNow()"
                    class="bg-blue-600 hover:bg-blue-500 text-white text-xs px-3 py-1 rounded uppercase font-bold tracking-wide">
                Entrar Agora
            </button>
        </div>
        <div class="flex justify-between items-end">
            <div>
                <p class="text-xs text-gray-400">Se entrou √†s:</p>
                <p id="entry-time" class="text-xl font-mono text-white">--:--</p>
            </div>
            <div class="text-right">
                <p class="text-xs text-gray-400">Deve sair √†s:</p>
                <p id="exit-time" class="text-3xl font-mono font-bold text-red-400">--:--</p>
            </div>
        </div>
    </section>
</main>

<!-- Popup Customizado -->
<div id="critical-popup" class="fixed inset-0 bg-black/70 flex items-center justify-center hidden">
  <div class="bg-red-700 p-6 rounded-xl shadow-xl text-center max-w-xs border-2 border-white">
    <h2 class="text-2xl font-bold mb-3">‚ö†Ô∏è ALERTA CR√çTICO ‚ö†Ô∏è</h2>
    <p id="popup-text" class="text-lg mb-4">Bombeiro em perigo</p>
    <button onclick="closePopup()" class="bg-white text-red-700 font-bold px-4 py-2 rounded">OK</button>
  </div>
</div>

<script>
lucide.createIcons();

const reservePressure = 50;
const NUM_FF = 6;

// Estado dos bombeiros
const firefighters = [];
for (let i = 0; i < NUM_FF; i++) {
    firefighters.push({
        name: "",
        volume: 6.8,
        consumption: 45,
        pressure: 300,
        entryTimeStr: "--:--",
        exitTimeStr: "--:--",
        entryTimestamp: null,
        initialMinutes: null,
        remainingMinutes: null,
        alertShown: false
    });
}

let activeIndex = 0; // 0..5
let notificationsEnabled = false;

// DOM refs
const nameInput       = document.getElementById("ff-name");
const pressureInput   = document.getElementById("pressure");
const resultMinutesEl = document.getElementById("result-minutes");
const progressBarEl   = document.getElementById("progress-bar");
const entryTimeEl     = document.getElementById("entry-time");
const exitTimeEl      = document.getElementById("exit-time");
const consumptionDisplay = document.getElementById("consumption-display");

// Popup
const popupEl = document.getElementById("critical-popup");
const popupTextEl = document.getElementById("popup-text");

// Pedir permiss√£o para notifica√ß√µes
async function askNotificationPermission() {
    if (!("Notification" in window)) return;
    try {
        const perm = await Notification.requestPermission();
        if (perm === "granted") notificationsEnabled = true;
    } catch (e) {
        notificationsEnabled = false;
    }
}
askNotificationPermission();

// Vibra√ß√£o (smartphones)
function vibrate(ms = 400) {
    if (navigator.vibrate) {
        navigator.vibrate(ms);
    }
}

// Aviso sonoro (beep simples)
function playBeep() {
    try {
        const AudioCtx = window.AudioContext || window.webkitAudioContext;
        const ctx = new AudioCtx();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();

        osc.type = "sine";          // tipo de onda
        osc.frequency.value = 1000; // Hz

        osc.connect(gain);
        gain.connect(ctx.destination);

        const now = ctx.currentTime;
        gain.gain.setValueAtTime(0.0001, now);
        gain.gain.exponentialRampToValueAtTime(0.8, now + 0.01);
        gain.gain.exponentialRampToValueAtTime(0.0001, now + 0.7);

        osc.start(now);
        osc.stop(now + 0.7);
    } catch (e) {
        console.warn("AudioContext n√£o suportado ou bloqueado pelo browser.", e);
    }
}

// Atualizar nome
function updateName(val) {
    firefighters[activeIndex].name = val;
}

// Selecionar bombeiro
function selectFF(n) {
    activeIndex = n - 1;
    renderUI();
}

// Carregar estado do bombeiro ativo para a UI
function renderUI() {
    highlightTabs();

    const f = firefighters[activeIndex];

    // Nome
    nameInput.value = f.name || "";

    // Press√£o
    pressureInput.value = f.pressure;

    // Entry / Exit
    entryTimeEl.textContent = f.entryTimeStr;
    exitTimeEl.textContent  = f.exitTimeStr;

    // Volume & Consumo bot√µes
    highlightVolumeButtons();
    highlightConsumptionButtons();

    // Atualizar tempo & barra
    updateTimeAndBar();
}

// Destacar tabs (inclui aviso <10 e <5 min)
function highlightTabs() {
    for (let i = 0; i < NUM_FF; i++) {
        const tab = document.getElementById(`tab-${i+1}`);
        if (!tab) continue;

        // Reset base
        tab.classList.remove("border-2","border-white","bg-red-600","animate-pulse","ring-2","ring-orange-400","ring-red-500");
        tab.classList.add("bg-gray-700","text-white");

        if (i === activeIndex) {
            tab.classList.remove("bg-gray-700");
            tab.classList.add("bg-red-600","border-2","border-white");
        }

        const f = firefighters[i];
        if (f.entryTimestamp && f.initialMinutes != null) {
            const elapsed   = (Date.now() - f.entryTimestamp) / 60000;
            const remaining = Math.max(0, Math.floor(f.initialMinutes - elapsed));

            if (remaining <= 5) {
                tab.classList.add("ring-2","ring-red-500","animate-pulse");
            } else if (remaining <= 10) {
                tab.classList.add("ring-2","ring-orange-400");
            }
        }
    }
}

// Destacar volume
function highlightVolumeButtons() {
    document.querySelectorAll(".vol-btn").forEach(btn => {
        btn.classList.remove("bg-red-600","border-white","text-white","shadow-lg","shadow-red-900/50");
        btn.classList.add("bg-gray-700");
    });
    const vol = firefighters[activeIndex].volume;
    const btn = document.getElementById(`vol-${vol}`);
    if (btn) {
        btn.classList.remove("bg-gray-700");
        btn.classList.add("bg-red-600","border-white","text-white","shadow-lg","shadow-red-900/50");
    }
}

// Destacar consumo
function highlightConsumptionButtons() {
    document.querySelectorAll(".cons-btn").forEach(btn => {
        btn.classList.remove("bg-red-600","border-white","text-white");
        btn.classList.add("bg-gray-700");
    });
    const cons = firefighters[activeIndex].consumption;
    const btn = document.getElementById(`cons-${cons}`);
    if (btn) {
        btn.classList.remove("bg-gray-700");
        btn.classList.add("bg-red-600","border-white","text-white");
    }
    const label = cons === 45 ? "Intenso (45 L/min)" : "Moderado (40 L/min)";
    consumptionDisplay.textContent = label;
}

// Set volume
function setVolume(v) {
    firefighters[activeIndex].volume = v;
    highlightVolumeButtons();
    updateTimeAndBar();
}

// Set consumo
function setConsumption(c) {
    firefighters[activeIndex].consumption = c;
    highlightConsumptionButtons();
    updateTimeAndBar();
}

// Ajustar press√£o
function adjustPressure(delta) {
    const f = firefighters[activeIndex];
    let val = parseInt(pressureInput.value) || 0;
    val += delta;
    if (val < 0) val = 0;
    if (val > 400) val = 400;
    f.pressure = val;
    pressureInput.value = val;
    updateTimeAndBar();
}

// Definir press√£o direta
function setPressure(val) {
    const f = firefighters[activeIndex];
    f.pressure = val;
    pressureInput.value = val;
    updateTimeAndBar();
}

// Quando o utilizador escreve na press√£o
function updatePressureInput() {
    const f = firefighters[activeIndex];
    f.pressure = parseInt(pressureInput.value) || 0;
    updateTimeAndBar();
}

// Calcula minutos te√≥ricos (sem entrada ainda)
function computePhysicalMinutes(f) {
    const usefulPressure = Math.max(0, f.pressure - reservePressure);
    const usefulLiters   = usefulPressure * f.volume;
    const minutes        = usefulLiters / f.consumption;
    return Math.floor(minutes);
}

// Atualiza o tempo dispon√≠vel e a barra
function updateTimeAndBar() {
    const f = firefighters[activeIndex];

    let minutes;
    if (f.entryTimestamp && f.initialMinutes != null) {
        // Countdown real ap√≥s entrada
        const elapsed = (Date.now() - f.entryTimestamp) / 60000;
        minutes = Math.max(0, Math.floor(f.initialMinutes - elapsed));
        f.remainingMinutes = minutes;
    } else {
        // Antes de entrar, mostra tempo te√≥rico
        minutes = computePhysicalMinutes(f);
        f.remainingMinutes = minutes;
        f.initialMinutes   = minutes;
    }

    resultMinutesEl.textContent = isNaN(minutes) ? "00" : String(minutes).padStart(2,"0");

    // Barra de progresso
    let pct = 100;
    if (f.initialMinutes && f.initialMinutes > 0) {
        pct = Math.max(0, Math.min(100, (minutes / f.initialMinutes) * 100));
    }
    progressBarEl.style.width = pct + "%";

    // Cores da barra
    if (minutes <= 5) {
        progressBarEl.style.background = "#dc2626"; // vermelho
    } else if (minutes <= 10) {
        progressBarEl.style.background = "#f97316"; // laranja
    } else {
        progressBarEl.style.background = "#22c55e"; // verde
    }
}

// Entrar Agora
function enterNow() {
    const f = firefighters[activeIndex];
    const now = new Date();

    // minutos te√≥ricos no momento da entrada
    const minutes = computePhysicalMinutes(f);
    if (minutes <= 0) return;

    f.entryTimestamp = Date.now();
    f.initialMinutes = minutes;
    f.remainingMinutes = minutes;

    f.entryTimeStr = now.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
    const exitTime = new Date(now.getTime() + minutes * 60000);
    f.exitTimeStr  = exitTime.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });

    // Reset do alerta para este bombeiro
    f.alertShown = false;

    entryTimeEl.textContent = f.entryTimeStr;
    exitTimeEl.textContent  = f.exitTimeStr;

    updateTimeAndBar();
    highlightTabs();
}

// Popup fechar
function closePopup() {
    popupEl.classList.add("hidden");
}

// Verifica√ß√£o peri√≥dica (cada minuto)
setInterval(() => {
    // Atualizar countdown de todos
    for (let i = 0; i < NUM_FF; i++) {
        const f = firefighters[i];
        if (f.entryTimestamp && f.initialMinutes != null) {
            const elapsed = (Date.now() - f.entryTimestamp) / 60000;
            const remaining = Math.max(0, Math.floor(f.initialMinutes - elapsed));
            f.remainingMinutes = remaining;

            // ALERTA CR√çTICO <5 MIN (uma vez por bombeiro)
            if (remaining <= 5 && !f.alertShown) {
                f.alertShown = true;

                // Vibra√ß√£o
                vibrate(500);

                // Som
                playBeep();

                // Notifica√ß√£o push (se permitido)
                if (notificationsEnabled && "Notification" in window) {
                    try {
                        new Notification(`üö® Bombeiro ${i+1}`, {
                            body: "Menos de 5 minutos de ar dispon√≠vel!",
                        });
                    } catch(e) {}
                }

                // Popup
                popupTextEl.textContent = `Bombeiro ${i+1} tem menos de 5 minutos!`;
                popupEl.classList.remove("hidden");

                // Alert do browser
                alert(`Bombeiro ${i+1} com autonomia cr√≠tica!`);
            }
        }
    }

    // Atualizar UI do ativo
    updateTimeAndBar();
    highlightTabs();
}, 60000);

// Inicializar UI
renderUI();
</script>

</body>
</html>
